# Define stages for the pipeline
stages:
  - build
  - test
.default_template: &default_template
  services:
    - name: postgres:latest  # Use latest PostgreSQL image as a service
      alias: postgres
      environment:
        POSTGRES_DB: "CFTdatabase"
        POSTGRES_USER: "postgres"
        POSTGRES_PASSWORD: "SopraHR2024++"
  before_script:
    - apk update && apk add --no-cache postgresql-dev gcc python3 python3-dev musl-dev  # Install PostgreSQL dependencies and Python
    - python3 -m ensurepip  # Ensure pip is installed
    - python3 -m pip install --upgrade pip  # Upgrade pip
    - python3 -m pip install -r requirements.txt  # Install Python dependencies
    - python3 manage.py migrate  # Apply database migrations

build:
  stage: build
  script:
    - python manage.py migrate
  only:
    - backend
test:
  stage: test
  script:
    - python manage.py test
  only:
    - backend